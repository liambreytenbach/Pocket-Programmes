<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pocket Programmes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
            background: url('https://raw.githubusercontent.com/liambreytenbach/Pocket-Programmes/c8288faa015ecfc97483cccb78ef0bc7bc1f244a/Web%20Background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #e6eef6;
        }

        .wrap {
            max-width: 800px;
            margin: 28px auto;
            padding: 20px;
        }

        h1 {
            margin: 0 0 20px 0;
            font-size: 22px;
        }

        .card {
            background: rgba(24,34,52,0.9);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.6);
        }

        label {
            display: block;
            margin: 12px 0 4px;
            font-size: 14px;
        }

        input, textarea {
            width: calc(100% - 30px);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #333;
            background: #0b1220;
            color: #fff;
            resize: vertical;
            margin-left: 30px;
        }

        textarea {
            min-height: 60px;
        }

        .button-link, .download-btn, #generate {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #60a5fa;
            color: #04263b;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            width: 180px;
            height: 50px;
            font-size: 16px;
            line-height: 20px;
        }

        #result {
            margin-top: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .generate-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            min-height: 80px;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }

            .generate-btn:hover {
                background-color: #45a049;
            }

        .field-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background: rgba(0,0,0,0.1);
            padding: 4px;
            border-radius: 6px;
            cursor: grab;
            transition: transform 0.2s;
        }

        .drag-handle {
            width: 20px;
            height: 20px;
            cursor: grab;
            flex-shrink: 0;
            margin-right: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .drag-handle::before {
                content: "☰";
                font-size: 18px;
                color: #60a5fa;
            }

        .dragging {
            opacity: 0.8;
            background: rgba(96,165,250,0.2);
            position: absolute;
            z-index: 1000;
            pointer-events: none;
        }

        .placeholder {
            height: 60px;
            margin-bottom: 12px;
            border: 2px dashed #60a5fa;
            border-radius: 6px;
        }

        .add-field {
            justify-content: center;
            background: rgba(24,34,52,0.9);
            padding: 0;
        }

            .add-field .drag-handle::before {
                content: "+";
                color: #60fa95;
                font-size: 18px;
            }

            .add-field button {
                flex: 1;
                height: 50px;
                margin: 0;
                font-size: 16px;
                border-radius: 8px;
                border: none;
                background: #4CAF50;
                color: white;
                cursor: pointer;
            }

                .add-field button:hover {
                    background: #45a049;
                }

        .qr-code {
            margin-top: 20px;
            padding: 5px;
            background: white;
            display: inline-block;
        }
    </style>

</head>
<body>
    <div class="wrap">
        <h1>Pocket Programmes Form</h1>
        <div class="card" id="formContainer">
            <button id="generate" class="generate-btn">Generate Programme Page</button>
        </div>
        <div id="result"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        const fields = [
            { id: "playName", label: "Play Name", type: "input", default: "Play" },
            { id: "theatre", label: "Theatre", type: "input", default: "Harold Pinter Theatre" },
            { id: "address", label: "Address", type: "input", default: "6 Panton Street, London, SW1Y 4DN" },
            { id: "website", label: "Website", type: "input", default: "https://www.haroldpintertheatre.co.uk/" },
            { id: "rundates", label: "Run Dates", type: "input", default: "11 September – 6 December 2025" },
            { id: "exactDate", label: "Date", type: "input" },
            { id: "exactTime", label: "Time of Performance", type: "input" },
            { id: "schedule", label: "Schedule", type: "textarea", default: "- Monday to Saturday: 7:30 PM\n- Saturday Matinee: 2:30 PM\n- Sunday: Dark" },
            { id: "runtime", label: "Running Time", type: "input", default: "1 hour 45 minutes (no interval)" },
            { id: "age", label: "Age Guidance", type: "input", default: "12+" },
            { id: "tickets", label: "Ticket Prices", type: "input", default: "From £20 (subject to a £3.95 transaction fee)" },
            { id: "smoking", label: "Smoking", type: "input", default: "Smoking on stage" },
            { id: "about", label: "About the Play", type: "textarea", default: "The Weir is a modern Irish classic..." },
            { id: "director", label: "Director", type: "input", default: "Conor McPherson" },
            { id: "cast", label: "Cast", type: "textarea", default: "- Brendan Gleeson as Jack\n- Owen McDonnell as Brendan" },
            { id: "synopsis", label: "Synopsis", type: "textarea", default: "On a stormy night in a remote pub..." },
            { id: "booking", label: "Booking Information", type: "textarea", default: "Official Box Office: https://..." },
            { id: "resources", label: "Additional Information", type: "textarea" }
        ];

        const formContainer = document.getElementById('formContainer');
        const generateBtn = document.getElementById('generate');
        let fieldCounter = 0;

        fields.forEach(f => createField(f, false));

        // --- Add Field button ---
        const addWrapper = document.createElement('div');
        addWrapper.className = 'field-wrapper add-field';

        const addHandle = document.createElement('div');
        addHandle.className = 'drag-handle';
        addWrapper.appendChild(addHandle);

        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add Field';
        addWrapper.appendChild(addBtn);

        formContainer.insertBefore(addWrapper, generateBtn);

        addBtn.addEventListener('click', () => {
            fieldCounter++;
            createField({ id: 'newField' + fieldCounter, label: 'New Field', type: 'input' }, true, addWrapper);
        });

        function createField(f, isNew = false, insertBefore = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'field-wrapper';
            wrapper.dataset.id = f.id;

            const handle = document.createElement('div');
            handle.className = 'drag-handle';
            wrapper.appendChild(handle);

            const label = document.createElement('label');
            label.textContent = f.label;
            label.contentEditable = 'true';
            wrapper.appendChild(label);

            let field;
            if (f.type === 'textarea') field = document.createElement('textarea');
            else { field = document.createElement('input'); field.type = 'text'; }
            field.id = f.id;
            if (f.default) field.value = f.default;
            wrapper.appendChild(field);

            if (insertBefore) formContainer.insertBefore(wrapper, insertBefore);
            else formContainer.insertBefore(wrapper, generateBtn);

            addDrag(wrapper, handle);
        }

        function addDrag(wrapper, handle) {
            let placeholder = null, dragging = false, offsetY = 0;

            handle.addEventListener('pointerdown', e => {
                e.preventDefault();
                if (dragging) return;
                dragging = true;

                const rect = wrapper.getBoundingClientRect();
                offsetY = e.clientY - rect.top;

                const existingPlaceholder = formContainer.querySelector('.placeholder');
                if (existingPlaceholder) existingPlaceholder.remove();

                placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.style.height = wrapper.offsetHeight + 'px';
                wrapper.parentNode.insertBefore(placeholder, wrapper.nextSibling);

                wrapper.classList.add('dragging');
                wrapper.style.width = rect.width + 'px';
                wrapper.style.position = 'absolute';
                wrapper.style.left = rect.left + 'px';
                wrapper.style.top = rect.top + 'px';
                wrapper.style.pointerEvents = 'none';

                document.body.appendChild(wrapper);
                wrapper.setPointerCapture(e.pointerId);
            });

            document.addEventListener('pointermove', e => {
                if (!dragging) return;
                wrapper.style.top = (e.clientY - offsetY + window.scrollY) + 'px';
                const wrappers = [...formContainer.querySelectorAll('.field-wrapper:not(.add-field):not(.dragging)')];
                for (let w of wrappers) {
                    const rect = w.getBoundingClientRect();
                    const mid = rect.top + rect.height / 2;
                    if (e.clientY < mid) {
                        formContainer.insertBefore(placeholder, w);
                        break;
                    } else {
                        formContainer.insertBefore(placeholder, w.nextSibling);
                    }
                }
            });

            document.addEventListener('pointerup', e => {
                if (!dragging) return;
                dragging = false;

                wrapper.classList.remove('dragging');
                wrapper.style.position = '';
                wrapper.style.top = '';
                wrapper.style.left = '';
                wrapper.style.width = '';
                wrapper.style.pointerEvents = '';

                if (placeholder && placeholder.parentNode) {
                    placeholder.parentNode.insertBefore(wrapper, placeholder);
                    placeholder.remove();
                    placeholder = null;
                }
            });
        }

        // --- Generate Programme & QR Code ---
        generateBtn.addEventListener('click', () => {
            const wrappers = [...formContainer.querySelectorAll('.field-wrapper:not(.add-field)')];

            let html = `<!doctype html><html><head><meta charset="utf-8"><title>Pocket Programmes</title>
<style>
        body { font-family: Arial,sans-serif; background:#0f1724; color:#e6eef6; padding:20px; line-height:1.6; }
        h1 { color:#60a5fa; }
        section { margin-bottom:20px; }
</style></head><body>
<h1>Programme</h1>`;

            let playName = '', theatreName = '';

            wrappers.forEach(w => {
                const label = w.querySelector('label').textContent.trim();
                const val = w.querySelector('input,textarea').value.trim();

                if (label.toLowerCase().includes('play name')) playName = val || 'Play';
                if (label.toLowerCase().includes('theatre')) theatreName = val || 'Theatre';

                if (val) {
                    html += `<section><strong>${label}:</strong> ${val}</section>`;
                }
            });

            html += '</body></html>';

            const fileName = `${theatreName.replace(/\s+/g, '')}_${playName.replace(/\s+/g, '')}.html`;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '';

            // Download page button
            const downloadPage = document.createElement('a');
            downloadPage.href = url;
            downloadPage.download = fileName;
            downloadPage.className = 'button-link download-btn';
            downloadPage.innerHTML = 'Download<br>Programme Page';
            resultDiv.appendChild(downloadPage);

            // QR Code container
            const qrDiv = document.createElement('div');
            qrDiv.id = 'qrcode';
            qrDiv.className = 'qr-code';
            resultDiv.appendChild(qrDiv);

            const qrUrl = `https://liambreytenbach.github.io/Pocket-Programmes/programmes/${fileName}`;
            new QRCode(qrDiv, {
                text: qrUrl,
                width: 200,
                height: 200
            });

            // QR Download button
            const qrDownload = document.createElement('button');
            qrDownload.textContent = 'Download QR Code';
            qrDownload.className = 'generate-btn';
            qrDownload.style.width = '200px';
            qrDownload.addEventListener('click', () => {
                const qrCanvas = qrDiv.querySelector('canvas');
                if (qrCanvas) {
                    const canvas = document.createElement('canvas');
                    const size = qrCanvas.width;
                    const border = 5;
                    canvas.width = size + border * 2;
                    canvas.height = size + border * 2;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(qrCanvas, border, border);
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = 'QRCode.png';
                    link.click();
                }
            });
            resultDiv.appendChild(qrDownload);
        });
    </script>
</body>
</html>
